<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Water Footprint Calculator â€” Demo</title>
  <!-- External libs (kept as CDN like your original) -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0f1724; /* deep navy */
      --card:#0b1220; /* card dark */
      --accent:#00d1ff; /* cyan */
      --accent-2:#6ee7b7; /* mint */
      --muted:#a7b0bf;
      --glass: rgba(255,255,255,0.04);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#021022 0%, #071429 60%);color:#e6eef6}
    .wrap{max-width:980px;margin:28px auto;padding:20px}
    h1{display:flex;align-items:center;gap:.6rem;font-size:1.6rem}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:18px;box-shadow:0 10px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}

    .controls{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    select,input[type=number]{background:var(--glass);border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:8px;color:var(--muted);min-width:180px}
    button{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:none;padding:10px 14px;border-radius:10px;color:#022;cursor:pointer;font-weight:600}
    .secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}

    #qr-reader{display:none;border-radius:10px;margin-top:12px}

    .list{margin-top:14px}
    .list table{width:100%;border-collapse:collapse}
    .list th,.list td{padding:8px;text-align:left;font-size:0.95rem;color:var(--muted)}
    .list tbody tr{background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border-radius:8px}

    .charts{display:flex;gap:18px;margin-top:18px}
    .charts canvas{background:transparent;border-radius:10px;padding:6px;flex:1}

    /* Popup modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:none;align-items:center;justify-content:center;z-index:60}
    .modal{width:380px;background:linear-gradient(180deg,#081022,#061221);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 18px 40px rgba(2,6,23,0.6);transform:translateY(30px);opacity:0}

    /* nice entrance */
    .modal.show{animation:popIn .45s cubic-bezier(.2,.9,.2,1) forwards}
    @keyframes popIn{0%{transform:translateY(30px) scale(.95);opacity:0}60%{transform:translateY(-6px) scale(1.02);opacity:1}100%{transform:translateY(0) scale(1);opacity:1}}

    .modal h3{margin:0 0 8px}
    .modal .big{font-size:1.4rem;font-weight:700;color:var(--accent-2)}

    /* small responsive */
    @media (max-width:720px){.charts{flex-direction:column}.wrap{padding:12px}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ’§ Water Footprint Calculator</h1>

    <div class="card">
      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="scanBtn" class="secondary">ðŸ“· Start Scan</button>
          <button id="stopScanBtn" class="secondary">â›” Stop Scan</button>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <label for="country" style="color:var(--muted)">Country</label>
          <select id="country">
            <option value="india">ðŸ‡®ðŸ‡³ India</option>
            <option value="usa">ðŸ‡ºðŸ‡¸ USA</option>
            <option value="uk">ðŸ‡¬ðŸ‡§ UK</option>
          </select>
        </div>
      </div>

      <div id="qr-reader" style="width:100%;height:280px;margin-top:12px"></div>

      <div class="controls">
        <select id="itemSelect"><option value="">-- Select item --</option></select>
        <input id="quantity" type="number" value="1" min="1" />
        <button id="addItemBtn">âž• Add Item</button>
        <button id="calculateBtn">Calculate Total</button>
      </div>

      <div class="list">
        <table>
          <thead><tr><th>Item</th><th>Qty</th><th>W.F / unit</th><th>Country-adj</th><th>Total</th><th></th></tr></thead>
          <tbody id="cartBody"></tbody>
        </table>
      </div>

      <div class="charts">
        <canvas id="waterChart"></canvas>
        <canvas id="comparisonChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Modal popup -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal" id="modal">
      <h3>Calculation Result</h3>
      <div id="modalContent"></div>
      <div style="margin-top:12px;display:flex;justify-content:flex-end">
        <button id="closeModal" class="secondary">Close</button>
      </div>
    </div>
  </div>

<script>
// ---------------------------------------------------
// Simple in-memory items database (barcode -> item)
// Each item stores base water footprint per unit (liters)
// and a multiplier per country to simulate variation
// ---------------------------------------------------
const ITEM_DB = {
  // some example EAN/UPC-like strings
  "8901234567890": {name: "Rice (1 kg)", base: 2500},
  "8901234567891": {name: "Wheat (1 kg)", base: 1600},
  "012345678905": {name: "Beef (1 kg)", base: 15400},
  "012345678906": {name: "Milk (1 L)", base: 1000},
  "111111111111": {name: "Tomato (1 kg)", base: 180},
  "222222222222": {name: "Coffee (250 g)", base: 13200}
};

const COUNTRY_MULT = {
  india: 0.9,
  usa: 1.15,
  uk: 1.0
};

// populate item select from ITEM_DB
const itemSelect = document.getElementById('itemSelect');
Object.entries(ITEM_DB).forEach(([code,item])=>{
  const opt = document.createElement('option');
  opt.value = code;
  opt.textContent = `${item.name}`;
  itemSelect.appendChild(opt);
});

// cart will hold objects {code, qty}
let cart = [];
const cartBody = document.getElementById('cartBody');

function renderCart(){
  cartBody.innerHTML = '';
  cart.forEach((entry, idx)=>{
    const item = ITEM_DB[entry.code];
    const tr = document.createElement('tr');
    const perUnit = item.base;
    const country = document.getElementById('country').value;
    const adj = (perUnit * COUNTRY_MULT[country]).toFixed(1);
    const total = (adj * entry.qty).toFixed(1);
    tr.innerHTML = `
      <td>${item.name}</td>
      <td>${entry.qty}</td>
      <td>${perUnit} L</td>
      <td>${adj} L</td>
      <td>${total} L</td>
      <td><button data-idx="${idx}" class="secondary removeBtn">Remove</button></td>
    `;
    cartBody.appendChild(tr);
  });
  // bind remove
  document.querySelectorAll('.removeBtn').forEach(b=>b.addEventListener('click',(e)=>{
    const i = Number(e.currentTarget.dataset.idx);
    cart.splice(i,1);
    renderCart();
  }))
}

// add item
document.getElementById('addItemBtn').addEventListener('click',()=>{
  const code = itemSelect.value;
  const qty = Number(document.getElementById('quantity').value) || 1;
  if(!code){alert('Select an item or scan one!');return}
  cart.push({code, qty});
  renderCart();
});

// Calculation and popup
const modalBackdrop = document.getElementById('modalBackdrop');
const modal = document.getElementById('modal');
const modalContent = document.getElementById('modalContent');
const closeModal = document.getElementById('closeModal');
closeModal.addEventListener('click',()=>{hideModal()});

function showModal(html){
  modalContent.innerHTML = html;
  modalBackdrop.style.display = 'flex';
  // give class to play animation
  setTimeout(()=> modal.classList.add('show'),10);
}
function hideModal(){
  modal.classList.remove('show');
  setTimeout(()=> modalBackdrop.style.display = 'none',300);
}

// charts
let waterChart=null, comparisonChart=null;
function drawCharts(breakdown){
  const ctx = document.getElementById('waterChart').getContext('2d');
  const labels = breakdown.map(b=>b.name);
  const data = breakdown.map(b=>b.total);
  if(waterChart) waterChart.destroy();
  waterChart = new Chart(ctx,{type:'bar',data:{labels, datasets:[{label:'Water footprint (L)',data}]},options:{plugins:{legend:{display:false}}}});

  const ctx2 = document.getElementById('comparisonChart').getContext('2d');
  // show country multipliers comparison
  const countryKeys = Object.keys(COUNTRY_MULT);
  const vals = countryKeys.map(k=>COUNTRY_MULT[k]);
  if(comparisonChart) comparisonChart.destroy();
  comparisonChart = new Chart(ctx2,{type:'pie',data:{labels:countryKeys.map(k=>k.toUpperCase()),datasets:[{data:vals}]}});
}

// Calculate total
document.getElementById('calculateBtn').addEventListener('click',()=>{
  if(cart.length===0){alert('Cart is empty. Add some items.');return}
  const country = document.getElementById('country').value;
  let grand=0;
  const breakdown = cart.map(entry=>{
    const item = ITEM_DB[entry.code];
    const per = item.base;
    const adj = per * COUNTRY_MULT[country];
    const total = adj * entry.qty;
    grand += total;
    return {name:item.name, qty: entry.qty, per, adj, total: Number(total.toFixed(1))}
  });

  // human friendly total
  const html = `
    <div style="display:flex;flex-direction:column;gap:8px">
      <div class="big">Total water footprint: ${grand.toFixed(1)} L</div>
      <div style="color:var(--muted)">Country adjusted by: ${country.toUpperCase()}</div>
      <hr style="border:none;border-top:1px dashed rgba(255,255,255,0.03)" />
      <div>
        ${breakdown.map(b=>`<div style="font-size:0.95rem;margin-bottom:6px">${b.name} â€” ${b.qty} Ã— ${b.adj.toFixed(1)} L = <strong>${b.total.toFixed(1)} L</strong></div>`).join('')}
      </div>
    </div>
  `;

  showModal(html);
  drawCharts(breakdown);
});

// ----------------- QR scanner integration -----------------
let html5QrScanner = null;
const scanBtn = document.getElementById('scanBtn');
const stopScanBtn = document.getElementById('stopScanBtn');
const qrReader = document.getElementById('qr-reader');

async function startScanner(){
  if(html5QrScanner) return;
  qrReader.style.display = 'block';
  // choose camera
  try{
    const devices = await Html5Qrcode.getCameras();
    const cameraId = (devices && devices.length) ? devices[0].id : null;
    html5QrScanner = new Html5Qrcode("qr-reader");
    await html5QrScanner.start(cameraId, {fps:10, qrbox:250}, qrSuccess, qrError);
  }catch(err){
    console.error('Unable to start scanner',err);
    alert('Could not access camera. Make sure to allow permission and try again.');
    qrReader.style.display = 'none';
    html5QrScanner = null;
  }
}

function stopScanner(){
  if(!html5QrScanner) return;
  html5QrScanner.stop().then(()=>{
    html5QrScanner.clear();
    html5QrScanner=null;
    qrReader.style.display = 'none';
  }).catch(err=>{
    console.warn('stop failed',err);
    qrReader.style.display = 'none';
    html5QrScanner=null;
  })
}

function qrSuccess(decodedText, decodedResult){
  // decodedText is the barcode/QR content
  console.log('scan',decodedText);
  // try to match in DB
  if(ITEM_DB[decodedText]){
    // auto-select the item and add to cart
    itemSelect.value = decodedText;
    // give a small animation feedback by showing a modal briefly
    const item = ITEM_DB[decodedText];
    showModal(`<div style="font-weight:700">Scanned: ${item.name}</div><div style="color:var(--muted);margin-top:8px">Added to selection â€” change qty and press Add</div>`);
    setTimeout(()=>hideModal(),1200);
  }else{
    // not found â€” show suggestion UI
    showModal(`<div style="font-weight:700">Unknown code</div><div style="color:var(--muted);margin-top:8px">Scanned: ${decodedText}. Not present in local DB.</div>`);
    setTimeout(()=>hideModal(),1700);
  }
}
function qrError(err){
  // quiet errors while scanning
}

scanBtn.addEventListener('click',()=>{
  startScanner();
});
stopScanBtn.addEventListener('click',()=>{
  stopScanner();
});

// Stop scanner when leaving page
window.addEventListener('beforeunload',()=>{ if(html5QrScanner) html5QrScanner.stop(); });

</script>
</body>
</html>
